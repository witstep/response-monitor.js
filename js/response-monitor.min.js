(function(global,undefined){"use strict";var factory=function(window){if(typeof window.document!=="object"){throw new Error("response-monitor.js requires a `window` with a `document` object")}var ResponseMonitor=function(trigger,options){var self=this;this.trigger=trigger;this.downloadTimer=null;this._validateTrigger();this._validateURL();if(typeof options==="undefined")options=this._configDefaultSpinner(options);var f=function(){};this.options={timeout:120,onRequest:f,onMonitor:f,onTimeout:f,onResponse:f,cookiePrefix:"response-monitor"};if(typeof options.timeout==="undefined"&&typeof this.hash!=="undefined")options.timeout=parseInt(this.hash.split("#")[1]);for(var attrname in options)this.options[attrname]=options[attrname];this.monitor=function(){var token=self._getCookie();if(typeof token!=="undefined"){window.setTimeout(function(){self.options.onResponse(token)},0);self._terminate()}else if(self.countdown===0){self._terminate();window.setTimeout(self.options.onTimeout,0)}self.options.onMonitor(self.countdown--)}};ResponseMonitor.prototype._configDefaultSpinner=function(options){var self=this;try{this.spinner=new Spinner;var onTerminate=function(status){self.spinner.stop();if(status===0)console.log("error")};return{onRequest:function(){self.spinner.spin();if(typeof self.trigger.nodeName!=="undefined")self.trigger.appendChild(self.spinner.el);else document.body.appendChild(self.spinner.el)},onResponse:onTerminate,onTimeout:function(){onTerminate();console.log("timeout")}}}catch(e){throw new Error("Please define options or make spin.js available")}};ResponseMonitor.prototype.execute=function(event){if(this.downloadTimer)return;if(typeof this.trigger.href!=="undefined")this.trigger.href="javascript:void(0);";this.countdown=this.options.timeout;if(typeof event!=="undefined")event.preventDefault();var date=new Date;var token=date.getTime();this.cookie={name:this.options.cookiePrefix+"_"+token,value:token};this._createIframe();this.downloadTimer=window.setInterval(this.monitor,1e3);var separator=this.url.indexOf("?")!==-1?"&":"?";var url=this.url+separator+this.options.cookiePrefix+"="+token;if(typeof this.form!=="undefined")this._submitForm(url);else this.iframe.src=url;this.options.onRequest(this.cookie.name)};ResponseMonitor.prototype._terminate=function(){if(typeof this.trigger.href!=="undefined")this.trigger.href=this.url+this.hash;if(typeof this.form!=="undefined"){if(this.form.ACTION=="GET")this.form.removeChild(this.hiddenInput)}window.clearInterval(this.downloadTimer);this.downloadTimer=null;this._expireCookie(this.cookie.name);this._removeIframe()};ResponseMonitor.prototype._getCookie=function(){var parts=document.cookie.split(this.cookie.name+"=");if(parts.length==2)return parts.pop().split(";").shift()};ResponseMonitor.prototype._expireCookie=function(name){document.cookie=encodeURIComponent(name)+"=deleted; expires="+new Date(0).toUTCString()};ResponseMonitor.prototype._submitForm=function(url){this.form.target=this.iframe.name;if(this.form.method.toUpperCase()=="GET"&&document.getElementById(this.options.cookiePrefix)===null){this.hiddenInput=document.createElement("input");this.hiddenInput.type="hidden";this.hiddenInput.name=this.options.cookiePrefix;this.hiddenInput.value=this.cookie.value;this.form.appendChild(this.hiddenInput);this.form.submit()}else{this.form.action=url;this.form.submit()}};ResponseMonitor.prototype._createIframe=function(){this.iframe=document.createElement("iframe");this.iframe.id=this.options.cookiePrefix+"_iframe_"+this.cookie.value;this.iframe.name=this.iframe.id;this.iframe.style.display="none";document.body.appendChild(this.iframe)};ResponseMonitor.prototype._removeIframe=function(){if(navigator.appName=="Microsoft Internet Explorer")this.iframe.contentWindow.document.execCommand("Stop");else this.iframe.contentWindow.stop();document.body.removeChild(this.iframe)};ResponseMonitor.prototype._invalidTriggerError=function(){return new Error("Invalid request trigger: '"+this.trigger+"'\nValid request triggers are HTML anchors, forms and URLs as strings.")};ResponseMonitor.prototype._validateTrigger=function(){var self=this;if(typeof this.trigger==="undefined"||this.trigger===null){throw this._invalidTriggerError()}else if(typeof this.trigger.href!=="undefined"&&this.trigger.nodeName=="A"){this.trigger.onclick=function(event){self.execute(event)};this.url=this.trigger.href}else if(typeof this.trigger.action!=="undefined"&&this.trigger.nodeName=="FORM"){this.trigger.onsubmit=function(event){self.execute(event)};this.form=this.trigger;this.url=this.trigger.action}else if(typeof this.trigger.nodeName==="undefined"){this.url=this.trigger}else{throw this._invalidTriggerError()}};ResponseMonitor.prototype._validateURL=function(){var parser=document.createElement("a");parser.href=this.url;if(parser.hostname!==""&&parser.protocol.indexOf("http")!==-1){this.url=parser.href.replace(parser.hash,"");this.hash=parser.hash;return true}return false};ResponseMonitor.register=function(trigger,options){var elementArray;if(typeof trigger.nodeName!=="undefined")elementArray=new Array(trigger);else elementArray=trigger;for(var i=0;i<elementArray.length;i++){if(typeof elementArray[i].nodeName==="undefined")throw new Error("Only HTML elements can be used as triggers");new ResponseMonitor(elementArray[i],options)}};ResponseMonitor.prototype.setTimeout=function(timeout){this.options.timeout=timeout};ResponseMonitor.prototype.setCookiePrefix=function(cookiePrefix){this.options.cookiePrefix=cookiePrefix};return ResponseMonitor};var responseMonitorExport=typeof global.document==="object"?factory(global):factory;if(typeof define==="function"&&define.amd){define(function(){return responseMonitorExport})}else if(typeof exports==="object"){if(typeof module==="object"&&typeof module.exports==="object"){exports=module.exports=responseMonitorExport}exports.ResponseMonitor=responseMonitorExport}else{global.ResponseMonitor=responseMonitorExport}})(typeof window==="undefined"?this:window);